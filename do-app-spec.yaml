name: ignacheck
region: fra
alerts:
  - rule: DEPLOYMENT_FAILED
  - rule: DOMAIN_FAILED

databases:
  - name: db
    engine: PG
    version: "15"
    production: true    # Managed Database (not dev DB)

services:
  # --- Backend API ---
  - name: api
    http_port: 8080
    instance_size_slug: basic-xxs
    instance_count: 1
    git:
      repo_clone_url: https://github.com/KudaMagwenzi/ignacheck-api.git
      branch: main
    dockerfile_path: Dockerfile
    envs:
      # Bind DB URL from the DB component
      - key: DATABASE_URL
        scope: RUN_AND_BUILD_TIME
        value: ${db.DATABASE_URL}
      # Spaces / OpenAI / JWT / Misc
      - key: REGION
        value: fra1
      - key: STORAGE_BACKEND
        value: s3
      - key: S3_ENDPOINT
        value: https://fra1.digitaloceanspaces.com
      - key: S3_REGION
        value: fra1
      - key: S3_BUCKET
        value: ignacheck-prod
      - key: S3_PUBLIC_URL_BASE
        value: https://ignacheck-prod.fra1.digitaloceanspaces.com
      - key: S3_ACCESS_KEY
        type: SECRET
        value: "CHANGE_ME"
      - key: S3_SECRET_KEY
        type: SECRET
        value: "CHANGE_ME"
      - key: OPENAI_API_KEY
        type: SECRET
        value: "CHANGE_ME"
      - key: JWT_SECRET
        type: SECRET
        value: "CHANGE_ME_64CHARS"
      - key: CORS_ORIGINS
        value: https://app.ignacheck.ai
      - key: SECURITY_HEADERS
        value: "true"
      - key: MAINTENANCE_MODE
        value: "false"
    routes:
      - path: /        # App Platform gives a default *.ondigitalocean.app URL
        preserve_path_prefix: true

  # --- Frontend (Next.js) ---
  - name: web
    http_port: 3000
    instance_size_slug: basic-xxs
    instance_count: 1
    git:
      repo_clone_url: https://github.com/<YOUR_GH_ORG>/ignacheck-web.git
      branch: main
    dockerfile_path: Dockerfile
    build_command: ""
    run_command: ""
    envs:
      - key: NODE_ENV
        value: production
      # set these AFTER first deploy to your API URL (copy the api service URL from DO)
      - key: API_BASE
        value: https://REPLACE_WITH_API_URL
      - key: NEXT_PUBLIC_API_BASE
        value: https://REPLACE_WITH_API_URL
    routes:
      - path: /
        preserve_path_prefix: true
